{% extends "base.html" %}

{% block title %}Tasks - AI Task Optimizer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="header-gradient p-4 rounded mb-4 fade-in">
                <h1 class="display-5 fw-bold">Task Management</h1>
                <p class="lead">Add, view, and manage your tasks for optimal scheduling</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card bounce-in">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Task</h5>
                </div>
                <div class="card-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label for="description" class="form-label">Task Description</label>
                            <input type="text" class="form-control" id="description" name="description" placeholder="What needs to be done?" required>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority" required>
                                    <option value="">Select Priority</option>
                                    <option value="high">High</option>
                                    <option value="medium">Medium</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="duration" class="form-label">Duration</label>
                                <input type="text" class="form-control" id="duration" name="duration" placeholder="e.g., 1h, 30m" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="type" class="form-label">Task Type</label>
                                <select class="form-select" id="type" name="type" required>
                                    <option value="">Select Type</option>
                                    <option value="study">Study</option>
                                    <option value="work">Work</option>
                                    <option value="personal">Personal</option>
                                    <option value="health">Health</option>
                                    <option value="family">Family</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="preferences" class="form-label">Preferences</label>
                            <input type="text" class="form-control" id="preferences" name="preferences" placeholder="e.g., needs silence, outdoors, flexible">
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Add Task</button>
                    </form>
                </div>
            </div>

            <div class="card mt-4 slide-in-left">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Pending Tasks</h5>
                    <span class="badge bg-primary">{{ tasks.pending|length }}</span>
                </div>
                <div class="card-body">
                    {% if tasks.pending %}
                        {% for task in tasks.pending %}
                        <div class="card task-card priority-{{ task.priority }} mb-3" id="task-{{ task.id }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h6 class="card-title">{{ task.description }}</h6>
                                    <span class="badge bg-{{ 'danger' if task.priority == 'high' else 'warning' if task.priority == 'medium' else 'success' }}">{{ task.priority }}</span>
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ task.duration }} | 
                                        <i class="fas fa-tag me-1"></i>{{ task.type }}
                                    </small>
                                </p>
                                <p class="card-text">{{ task.preferences }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Added: {{ task.added_date.strftime('%d/%m/%Y') if task.added_date else 'N/A' }}</small>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-success complete-task" data-id="{{ task.id }}">
                                            <i class="fas fa-check me-1"></i>Complete
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-task" data-id="{{ task.id }}" title="Delete task">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No pending tasks. Add some tasks to get started!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card slide-in-right">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Task History</h5>
                    <span class="badge bg-success">{{ tasks.completed|length }}</span>
                </div>
                <div class="card-body">
                    {% if tasks.completed %}
                        {% for task in tasks.completed %}
                        <div class="card mb-2 completed-task" id="completed-task-{{ task.id }}">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <span><i class="fas fa-check-circle text-success me-1"></i> {{ task.description }}</span>
                                        <br><small class="text-muted">Completed: {{ task.completed_date.strftime('%d/%m/%Y') if task.completed_date else 'N/A' }}</small>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <span class="badge bg-secondary">{{ task.type }}</span>
                                        <button class="btn btn-sm btn-danger delete-task" data-id="{{ task.id }}" title="Delete task">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No completed tasks yet.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card mt-4 slide-in-right">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Tips</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>Be specific with task descriptions</li>
                        <li>Estimate durations realistically</li>
                        <li>Set appropriate priorities</li>
                        <li>Complete tasks to track your progress</li>
                        <li>Regularly review and update your tasks</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add task form submission
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading animation
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Adding...';
        submitBtn.disabled = true;
        
        const formData = new FormData(this);
        const data = {
            action: 'add',
            description: formData.get('description'),
            priority: formData.get('priority'),
            duration: formData.get('duration'),
            type: formData.get('type'),
            preferences: formData.get('preferences')
        };
        
        $.ajax({
            url: '/api/tasks',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showNotification('Task added successfully!', 'success');
                document.getElementById('taskForm').reset();
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function() {
                showNotification('Error adding task', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    });
    
    // Complete task buttons
    document.querySelectorAll('.complete-task').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-id');
            const taskElement = document.getElementById(`task-${taskId}`);
            
            // Show loading animation
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="loading"></span>';
            this.disabled = true;
            
            const data = {
                action: 'complete',
                id: parseInt(taskId)
            };
            
            $.ajax({
                url: '/api/tasks',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    showNotification('Task completed successfully!', 'success');
                    // Add animation effect
                    taskElement.style.transition = 'all 0.5s ease';
                    taskElement.style.transform = 'translateX(100%)';
                    taskElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                },
                error: function() {
                    showNotification('Error completing task', 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            });
        });
    });
    
    // Delete task buttons
    document.querySelectorAll('.delete-task').forEach(button => {
        button.addEventListener('click', function() {
            const taskId = this.getAttribute('data-id');
            
            // Show confirmation dialog
            showDeleteConfirmation(taskId);
        });
    });
    
    // Add hover effects
    $('.task-card').hover(
        function() {
            $(this).css('transform', 'translateX(5px)');
        },
        function() {
            $(this).css('transform', 'translateX(0)');
        }
    );
});

function showDeleteConfirmation(taskId) {
    // Create modal HTML
    const modalHTML = `
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this task? This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmDelete">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    $('#deleteModal').remove();
    
    // Add modal to body
    $('body').append(modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    // Handle delete confirmation
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const deleteBtn = this;
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<span class="loading"></span> Deleting...';
        deleteBtn.disabled = true;
        
        const data = {
            action: 'delete',
            id: parseInt(taskId)
        };
        
        $.ajax({
            url: '/api/tasks',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                modal.hide();
                showNotification('Task deleted successfully!', 'success');
                
                // Find and remove the task element
                const taskElement = document.getElementById(`task-${taskId}`) || document.getElementById(`completed-task-${taskId}`);
                if (taskElement) {
                    taskElement.style.transition = 'all 0.5s ease';
                    taskElement.style.transform = 'translateX(-100%)';
                    taskElement.style.opacity = '0';
                    
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                }
            },
            error: function() {
                showNotification('Error deleting task', 'error');
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        });
    });
}

function showNotification(message, type) {
    // Create notification element
    const notification = $(`
        <div class="notification alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed" style="top: 20px; right: 20px; z-index: 9999; animation: slideInRight 0.3s ease;">
            ${message}
        </div>
    `);
    
    // Add to body
    $('body').append(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.fadeOut(() => {
            notification.remove();
        });
    }, 3000);
}
</script>
{% endblock %}